#!/bin/sh

warning_start=20
warning_inc=5
cache_file="${XDG_RUNTIME_HOME:-/run/user/$(id -u)}/checkbattery-last"

if ! grep Discharging /sys/class/power_supply/BAT0/status >/dev/null; then
	rm -f $cache_file
	exit 0
fi

[ ! -f $cache_file ] && echo $((warning_start + warning_inc)) > $cache_file

max=$(cat $cache_file)
now=$(cat /sys/class/power_supply/BAT0/capacity)

if [ $((now + warning_inc)) -le "$max" ]; then
	notify-send -u critical -a 'system health' 'Low battery' "battery is at $now%"
	echo "$now" > $cache_file
fi
