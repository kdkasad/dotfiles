#!/bin/sh

dmenuopts="-i -h 32"

target="$( dmenu $dmenuopts $@ -p "choose state:" << eof || printf 'cancelled'
power off
reboot
suspend
hibernate
hybrid sleep
suspend then hibernate
eof
)"

case "$target" in
	*cancelled) exit 1 ;;
esac

case "$target" in
	suspend|hibernate|"hybrid sleep"|"suspend then hibernate")
		lockfirst="$( printf "yes\nno" | dmenu $dmenuopts $@ -p "lock first?" || printf cancelled )"
		;;
esac

echo "$lockfirst" | grep cancelled >/dev/null 2>&1 \
	&& exit 1

case "$lockfirst" in
	*cancelled) exit 1 ;;
	*y*) setsid -f slock ;;
esac

case "$target" in
	"suspend") loginctl suspend ;;
	"power off") loginctl poweroff ;;
	"reboot") loginctl reboot ;;
	"hibernate") loginctl hibernate ;;
	"hybrid sleep") loginctl hybrid-sleep ;;
	"suspend then hibernate") loginctl suspend-then-hibernate ;;
	*) echo "$0: unknown option: $target" ; exit 1
esac
