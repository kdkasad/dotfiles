#!/bin/sh

suffix="-caps"

for vidfile in "$1"/*; do
	[ -f "$vidfile" ] || continue
	dest="$(echo "$vidfile" | tr -d ",()[]{}!@#$%^&*=‘’“”'\"" | tr '[:upper:]' '[:lower:]' | tr '_ ' '-' | sed 's/-\+/-/g')"
	[ "$vidfile" = "$dest" ] && continue
	echo "$vidfile"
	echo "==>"
	echo "$dest"
	mv -i "$vidfile" "$dest"
	echo
done

for vidfile in "$1"/*.mp4 "$1"/*.webm; do
	[ "${vidfile%.*}" = "$1/*" ] && continue
	echo "$vidfile"
	echo "==>"
	echo "${vidfile%.*}.mkv"
	ffmpeg -stats -loglevel warning -i "$vidfile" -c copy -f matroska "${vidfile%.*}.mkv" && \
		rm -f "$vidfile" || \
		printf "\033[01;31merror\033[00m\n" >&2
	echo
done

for capfile in "$1"/*.*.vtt; do
	vidfile="${capfile%.*.vtt}.mkv"
	[ -f "$vidfile" ] || continue
	echo "$vidfile"
	echo "$capfile"
	echo "==>"
	echo "${vidfile%.mkv}$suffix.mkv"
	ffmpeg -stats -loglevel warning -i "$vidfile" -i "$capfile" -c copy "${vidfile%.mkv}$suffix.mkv" && \
		rm -f "$capfile" "$vidfile" || \
		printf "\033[01;31merror\033[00m\n" >&2
	echo
done
