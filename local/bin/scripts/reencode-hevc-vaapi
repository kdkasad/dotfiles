#!/bin/sh

# choose suffix to append to re-encoded files
# this is overridden by the SUFFIX environment variable
suffix='hevc'

suffix="${SUFFIX:-$suffix}"

# loop through all mkv files
for vidfile in "$@"; do
	# skip files ending in -hevc
	[ "${vidfile%.mkv}" = *-hevc ] && continue

	# print filename
	echo "$vidfile"

	# reencode using hevc_vaapi codec
	# if successful, delete original file
	# on failure, print 'error' in red
	ffmpeg -stats -loglevel warning -hwaccel vaapi -hwaccel_output_format vaapi -i "$vidfile" -c:a copy -c:s copy -c:v hevc_vaapi "${vidfile%.mkv}-$suffix.mkv" && \
		rm -f "$vidfile" || \
		echo -e "\e[01;31merror\e[00m" >&2
done
