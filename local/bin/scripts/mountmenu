#!/bin/sh

available_devices=$(lsblk -rnpo 'NAME,SIZE,TYPE,MOUNTPOINT' | awk '$3=="part"&&$4==""{printf "%s (%s)\n",$1,$2}')
if [ -z "$available_devices" ]; then
	notify-send -a 'device manager' 'no devices found'
	exit 0
fi

device=$(echo "$available_devices" | bemenu -i -l 10 -p 'Choose device' "$@" | awk '{print $1}')
[ -z "$device" ] && exit 1

mountpoint=$(find /mnt /media /mount ~ -maxdepth 5 -not -path '/mnt/nas/*' -not -path '*/\.*' -type d -empty 2>/dev/null | sed "s|^$HOME|~|" | bemenu -i -l 30 -p 'Choose mountpoint' "$@" | sed "s|^~|$HOME|")
[ -z "$mountpoint" ] && exit 1

if [ ! -d $mountpoint ]; then
	(mkdir -p $mountpoint || sudo -A mkdir -p $mountpoint) || notify-send -a "device manager" "Error mounting device" "Could not create directory: $mountpoint" & exit 2
fi

tmpfile=$(mktemp)
(sudo -A mount "$device" "$mountpoint" -o user 2>$tmpfile) &&
	(rm $tmpfile ; pgrep dunst >/dev/null && 
		notify-send -a 'device manager' "Successfully mounted device" "$device was mounted to $(echo -n $mountpoint | sed "s|^$HOME|~|")") ||
	(pgrep dunst >/dev/null && notify-send -a 'device manager' "Error mounting device" "$device could not be mounted to $(echo -n $mountpoint | sed "s|^$HOME|~|").\nOpening the error file..." ; 
		$TERMINAL -e less $tmpfile &)
